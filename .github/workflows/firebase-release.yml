name: Firebase Release
on:
  workflow_dispatch:
    inputs:
      branch:
        description: "Branch to build"
        required: true
        default: "main"
      versionCode:
        description: "Android versionCode"
        required: true
      versionName:
        description: "Android versionName"
        required: true
      releaseNotes:
        description: "Release notes"
        required: false
        default: "CI build"
jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch }}
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
      - name: Decode keystore
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > release.jks
      - name: Grant execute permission
        run: chmod +x ./gradlew
      - name: Build release APK
        run: |
          ./gradlew assembleRelease \
            -PVERSION_CODE=${{ github.event.inputs.versionCode }} \
            -PVERSION_NAME=${{ github.event.inputs.versionName }}
        env:
          KEYSTORE_PATH: release.jks
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          RELEASE_SIGN_KEY_ALIAS: ${{ secrets.RELEASE_SIGN_KEY_ALIAS }}
          RELEASE_SIGN_KEY_PASSWORD: ${{ secrets.RELEASE_SIGN_KEY_PASSWORD }}
      - name: Upload to Firebase App Distribution
        uses: wzieba/Firebase-Distribution-Github-Action@v1
        with:
          appId: ${{ secrets.FIREBASE_APP_ID }}
          serviceCredentialsFileContent: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_JSON }}
          groups: testers
          releaseNotes: ${{ github.event.inputs.releaseNotes }}
          file: app/build/outputs/apk/release/app-release.apk