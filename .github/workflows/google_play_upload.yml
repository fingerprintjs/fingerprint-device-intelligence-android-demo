name: Google Play Release

on:
  workflow_dispatch:
    inputs:
      branch:
        description: "Branch to build from"
        required: true
        default: "main"
      versionCode:
        description: "Android versionCode"
        required: true
      versionName:
        description: "Android versionName"
        required: true
      track:
        description: "Google Play track (internal, production)"
        required: true
        default: "production"

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------
      # Checkout selected branch
      # -----------------------------
      - name: Checkout branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch }}

      # -----------------------------
      # Setup Java
      # -----------------------------
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: gradle

      # -----------------------------
      # Decode signing keystore
      # -----------------------------
      - name: Decode keystore
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > release.keystore

      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      # -----------------------------
      # Build signed AAB
      # -----------------------------
      - name: Build Release AAB
        run: |
          ./gradlew bundleRelease \
            -PVERSION_CODE=${{ github.event.inputs.versionCode }} \
            -PVERSION_NAME=${{ github.event.inputs.versionName }}
        env:
          KEYSTORE_PATH: release.keystore
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.RELEASE_SIGN_KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.RELEASE_SIGN_KEY_PASSWORD }}

      # -----------------------------
      # Upload to Google Play
      # -----------------------------
      - name: Upload to Google Play
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
          packageName: com.fingerprintjs.android.fpjs_pro_demo
          releaseFiles: app/build/outputs/bundle/release/app-release.aab
          track: ${{ github.event.inputs.track }}
          status: completed
